{% extends 'base.html' %}

{% load static %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Your existing dashboard cards -->
    </div>
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    My Children
                    <button class="btn btn-primary float-right" data-toggle="modal" data-target="#addChildModal">Add Child</button>
                </div>
                <div class="card-body">
                    {% for item in children_with_applications %}
                        <div class="card mb-3">
                            <div class="row no-gutters">
                                <div class="col-md-4">
                                    <img src="{% static 'images/child_avatar.jpg' %}" class="card-img" alt="Child Avatar">
                                </div>
                                <div class="col-md-8">
                                    <div class="card-body">
                                        <h5 class="card-title">{{ item.child.name }}</h5>
                                        <p class="card-text">Gender: {{ item.child.gender }}</p>
                                        <p class="card-text">Date of Birth: {{ item.child.dob }}</p>
                                        <p class="card-text">Age: {{ item.child.age }} years</p>
                                        <p class="card-text">NHS Number: {{ item.child.nhs_number }}</p>
                                        <button class="btn btn-danger" data-toggle="modal" data-target="#deleteChildModal" data-child-id="{{ item.child.id }}" data-child-name="{{ item.child.name }}">Delete</button>
                                        {% if item.child.age >= 4 and item.child.age <= 15 %}
                                            {% if not item.has_application %}
                                                <button class="btn btn-primary apply-school-btn" data-toggle="modal" data-target="#applySchoolModal" data-child-id="{{ item.child.id }}" data-child-name="{{ item.child.name }}" data-child-dob="{{ item.child.dob }}" data-child-nhs="{{ item.child.nhs_number }}" data-child-gender="{{ item.child.gender }}" data-child-age="{{ item.child.age }}">Apply for Schools</button>
                                            {% endif %}
                                            {% if item.has_application %}
                                                <a href="{% url 'application_tracking' item.child.id %}" class="btn btn-info mt-2">Track Applications</a>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

</div>

<!-- Add Child Modal -->
<div class="modal fade" id="addChildModal" tabindex="-1" aria-labelledby="addChildModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addChildModalLabel">Add Child Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'add_child' %}">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="name">Name</label>
                        <input type="text" class="form-control" id="name" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="dob">Date of Birth</label>
                        <input type="date" class="form-control" id="dob" name="dob" required>
                    </div>
                    <div class="form-group">
                        <label for="gender">Gender</label>
                        <select class="form-control" id="gender" name="gender" required>
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="nhs_number">NHS Number</label>
                        <input type="text" class="form-control" id="nhs_number" name="nhs_number" required>
                    </div>
                    <div class="form-group">
                        <label for="postcode">Postcode</label>
                        <input type="text" class="form-control" id="postcode" name="postcode" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Child</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Apply for Schools Modal -->
<div class="modal fade" id="applySchoolModal" tabindex="-1" aria-labelledby="applySchoolModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="applySchoolModalLabel">Apply for Schools</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="applySchoolForm" method="post" action="{% url 'apply_school' %}">
                    {% csrf_token %}
                    <!-- Step 1: Child Details -->
                    <div id="step1">
                        <h5>Child Details</h5>
                        <p>Name: <span id="childName"></span></p>
                        <p>Date of Birth: <span id="childDob"></span></p>
                        <p>Age: <span id="childAge"></span></p>
                        <p>NHS Number: <span id="childNhs"></span></p>
                        <p>Gender: <span id="childGender"></span></p>
                        <div class="form-group">
                            <label for="latitude">Latitude</label>
                            <input type="text" class="form-control" id="latitude" name="latitude" required>
                        </div>
                        <div class="form-group">
                            <label for="longitude">Longitude</label>
                            <input type="text" class="form-control" id="longitude" name="longitude" required>
                        </div>
                        <button type="button" class="btn btn-primary" id="searchSchools">Search Schools</button>
                    </div>

                    <!-- Step 2: School Selection -->
                    <div id="step2" style="display:none;">
                        <h5>Nearby Schools</h5>
                        <div id="schoolList" style="height: 400px; overflow-y: auto;"></div>
                        <button type="button" class="btn btn-secondary" id="backToStep1">Back</button>
                        <button type="button" class="btn btn-primary" id="nextToStep3">Next</button>
                    </div>

                    <!-- Step 3: School Preferences -->
                    <div id="step3" style="display:none;">
                        <h5>School Preferences</h5>
                        <div id="selectedSchools"></div>
                        <button type="button" class="btn btn-secondary" id="backToStep2">Back</button>
                        <button type="button" class="btn btn-primary" id="nextToStep4">Next</button>
                    </div>

                    <!-- Step 4: Confirm Details -->
                    <div id="step4" style="display:none;">
                        <h5>Confirm Details</h5>
                        <div id="confirmationChildDetails">
                            <p>Name: <span id="confirmChildName"></span></p>
                            <p>Date of Birth: <span id="confirmChildDob"></span></p>
                            <p>Age: <span id="confirmChildAge"></span></p>
                            <p>NHS Number: <span id="confirmChildNhs"></span></p>
                            <p>Gender: <span id="confirmChildGender"></span></p>
                        </div>
                        <div id="confirmationPreferences"></div>
                        <button type="button" class="btn btn-secondary" id="backToStep3">Back</button>
                        <button type="submit" class="btn btn-success" id="submitApplication">Submit Application</button>
                    </div>

                    <input type="hidden" id="childId" name="child_id">
                    <input type="hidden" id="latHidden" name="latitude"> <!-- Hidden field for latitude -->
                    <input type="hidden" id="lngHidden" name="longitude">
                    <input type="hidden" id="selectedSchoolIds" name="selected_school_ids">
                </form>
                <button type="button" class="btn btn-secondary" id="saveDraft">Save Draft</button>
            </div>
        </div>
    </div>
</div>




<!-- Delete Child Modal -->
<div class="modal fade" id="deleteChildModal" tabindex="-1" aria-labelledby="deleteChildModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteChildModalLabel">Delete Child</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete <span id="childNameToDelete"></span>?
            </div>
            <div class="modal-footer">
                <form id="deleteChildForm" method="post" action="">
                    {% csrf_token %}
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
$(document).ready(function () {
    $('.apply-school-btn').on('click', function () {
        const childId = $(this).data('child-id');
        const childName = $(this).data('child-name');
        const childDob = $(this).data('child-dob');
        const childNhs = $(this).data('child-nhs');
        const childGender = $(this).data('child-gender');
        const childAge = $(this).data('child-age');

        // Set child details in the modal
        $('#childName').text(childName);
        $('#childDob').text(childDob);
        $('#childAge').text(childAge);
        $('#childNhs').text(childNhs);
        $('#childGender').text(childGender);
        $('#childId').val(childId);
    });

    $('#nextToStep3').on('click', function () {
        const selectedSchools = [];
        $('.schoolCheckbox:checked').each(function () {
            const schoolId = $(this).val();
            const schoolTitle = $(this).data('title');
            selectedSchools.push({
                id: schoolId,
                title: schoolTitle
            });
        });

        console.log('Selected Schools:', selectedSchools);

        if (selectedSchools.length === 0) {
            alert('Please select at least one school.');
            return;
        }

        $('#selectedSchools').empty();
        selectedSchools.forEach((school, index) => {
            $('#selectedSchools').append(`
                <div class="form-group">
                    <label for="preference${index}">Preference ${index + 1}: ${school.title}</label>
                    <select class="form-control" id="preference${index}" name="preferences[]">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                    <div class="form-check mt-2">
                        <input class="form-check-input sibling-checkbox" type="checkbox" value="${school.id}" id="siblingCheck${index}" data-index="${index}">
                        <label class="form-check-label" for="siblingCheck${index}">
                            Do you have any siblings in this school?
                        </label>
                    </div>
                    <div class="sibling-info mt-2" id="siblingInfo${index}" style="display:none;">
                        <div class="form-group">
                            <label for="siblingName${index}">Sibling Name</label>
                            <input type="text" class="form-control sibling-name" id="siblingName${index}" name="siblings[${index}][name]">
                        </div>
                        <div class="form-group">
                            <label for="siblingDob${index}">Sibling Date of Birth</label>
                            <input type="date" class="form-control sibling-dob" id="siblingDob${index}" name="siblings[${index}][dob]">
                        </div>
                        <div class="form-group">
                            <label for="siblingYearGroup${index}">Sibling Year Group</label>
                            <input type="text" class="form-control sibling-year-group" id="siblingYearGroup${index}" name="siblings[${index}][year_group]">
                        </div>
                    </div>
                </div>
            `);
        });

        $('.sibling-checkbox').on('change', function () {
            const index = $(this).data('index');
            if ($(this).is(':checked')) {
                $(`#siblingInfo${index}`).show();
            } else {
                $(`#siblingInfo${index}`).hide();
            }
        });

        $('#step2').hide();
        $('#step3').show();
    });

    $('#nextToStep4').on('click', function () {
    $('#confirmChildName').text($('#childName').text());
    $('#confirmChildDob').text($('#childDob').text());
    $('#confirmChildAge').text($('#childAge').text());
    $('#confirmChildNhs').text($('#childNhs').text());
    $('#confirmChildGender').text($('#childGender').text());

    $('#confirmationPreferences').empty();
    const siblingData = [];
    let hasPreferences = false;

    $('#selectedSchools .form-group').each(function (index) {
        const schoolTitle = $(this).find('label').text().split(': ')[1];
        const preferenceValue = $(this).find('select').val();
        const siblingCheckbox = $(this).find('.sibling-checkbox').is(':checked');
        const siblingName = $(this).find('.sibling-name').val();
        const siblingDob = $(this).find('.sibling-dob').val();
        const siblingYearGroup = $(this).find('.sibling-year-group').val();

        if (schoolTitle && preferenceValue) {
            hasPreferences = true;
            const preference = {
                preference: index + 1,
                school_title: schoolTitle,
                preference_value: preferenceValue,
                siblings: []
            };

            if (siblingCheckbox) {
                preference.siblings.push({
                    name: siblingName,
                    dob: siblingDob,
                    year_group: siblingYearGroup,
                    school_id: $(this).find('.sibling-checkbox').val()  // Ensure school ID is captured correctly
                });
            }

            siblingData.push(preference);

            let siblingInfoHtml = '';
            if (siblingCheckbox) {
                siblingInfoHtml = `
                    <p>Sibling Name: ${siblingName}</p>
                    <p>Sibling Date of Birth: ${siblingDob}</p>
                    <p>Sibling Year Group: ${siblingYearGroup}</p>
                `;
            }

            $('#confirmationPreferences').append(`
                <div>
                    <p>Preference ${index + 1}: ${schoolTitle}</p>
                    <p>Preference Value: ${preferenceValue}</p>
                    ${siblingInfoHtml}
                </div>
            `);
        }
    });

    if (!hasPreferences) {
        alert('Please provide at least one preference.');
        return;
    }

    console.log('Sibling Data:', siblingData);

    $('<input>').attr({
        type: 'hidden',
        name: 'sibling_data',
        value: JSON.stringify(siblingData)
    }).appendTo('#applySchoolForm');

    $('#step3').hide();
    $('#step4').show();
});


    $('#applySchoolForm').on('submit', function (e) {
        e.preventDefault();

        var selectedSchools = [];
        $('.schoolCheckbox:checked').each(function () {
            selectedSchools.push($(this).val());
        });
        $('#selectedSchoolIds').val(selectedSchools.join(','));

        console.log('Selected School IDs:', selectedSchools);

        $('#applySchoolForm')[0].submit();
    });

    $('#searchSchools').on('click', function () {
        var latitude = $('#latitude').val();
        var longitude = $('#longitude').val();
        if (!latitude || !longitude) {
            alert('Please enter latitude and longitude.');
            return;
        }
        fetchNearbySchools(latitude, longitude);
        $('#latHidden').val(latitude);
        $('#lngHidden').val(longitude);
        $('#step1').hide();
        $('#step2').show();
    });

    $('#backToStep3').on('click', function () {
        $('#step4').hide();
        $('#step3').show();
    });

    $('#backToStep2').on('click', function () {
        $('#step3').hide();
        $('#step2').show();
    });

    $('#backToStep1').on('click', function () {
        $('#step2').hide();
        $('#step1').show();
    });

    function fetchNearbySchools(lat, lng) {
        const apiKey = 'iW9ceziSt7BhDuG3FZGbuRkk09ETfoDJznAqwbcjMBw';
        const url = `https://discover.search.hereapi.com/v1/discover?at=${lat},${lng}&q=schools&apiKey=${apiKey}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                const schoolList = document.getElementById('schoolList');
                schoolList.innerHTML = '';
                data.items.forEach(school => {
                    const schoolElement = document.createElement('div');
                    schoolElement.innerHTML = `
                        <p><strong>${school.title}</strong></p>
                        <p>Distance: ${school.distance} meters</p>
                        <label><input type="checkbox" class="schoolCheckbox" value="${school.id}" data-title="${school.title}"> Select</label>
                    `;
                    schoolList.appendChild(schoolElement);
                });
            })
            .catch(error => console.error('Error fetching nearby schools:', error));
    }
});

<!--Delete Child Modal    -->

  $('#deleteChildModal').on('show.bs.modal', function (event) {
  var button = $(event.relatedTarget);
  var childId = button.data('child-id');
  var childName = button.data('child-name');

  var modal = $(this);
  modal.find('.modal-body #childNameToDelete').text(childName);
  modal.find('.modal-footer #deleteChildForm').attr('action', '{% url "delete_child" 0 %}'.replace('0', childId));
});


</script>

{% endblock %}
